# 项目任务规划

## 概述

根据设计规范文档，我们将实现一个简化版的 mysqldump 工具，专注于导出 MySQL 表数据为 SQL 格式。本任务规划文档将详细列出实现步骤和时间安排。

## 任务分解

### 第一阶段：环境准备和基础架构 (预计时间: 1天)

- [x] **初始化项目结构**
   - [x] 创建目录结构
   - [x] 初始化 go.mod 文件
   - [x] 添加必要的依赖 (github.com/go-sql-driver/mysql)

- [x] **配置管理模块**
   - [x] 实现配置加载功能 (internal/config/config.go)
   - [x] 确保所有配置都通过环境变量加载
   - [x] 编写配置模块的单元测试 (internal/config/config_test.go)

- [x] **日志系统**
   - [x] 配置全局日志记录器
   - [x] 实现统一的日志接口

### 第二阶段：核心功能开发 (预计时间: 2天)

- [x] **数据库连接模块**
   - [x] 实现数据库连接功能 (internal/db/connection.go)
   - [x] 实现基本的查询功能
   - [x] 添加连接池管理

- [x] **表结构分析模块**
   - [x] 实现 information_schema.COLUMNS 查询功能 (internal/schema/analyzer.go)
   - [x] 实现生成列识别和过滤功能
   - [x] 构建实际导出列列表

- [x] **数据导出模块**
   - [x] 实现数据查询功能 (internal/exporter/data.go)
   - [x] 实现 INSERT 语句生成功能（包含具体列名）
   - [x] 实现基本环境设置语句生成

### 第三阶段：集成和主程序 (预计时间: 1天)

- [x] **核心流程控制**
   - [x] 实现主流程协调 (internal/core/dump.go)
   - [x] 整合各模块功能

- [x] **命令行接口**
   - [x] 实现主程序入口 (cmd/dump/main.go)
   - [x] 实现命令行参数解析
   - [x] 实现错误处理和提示信息

- [ ] **端到端测试**
   - [ ] 实现完整的导出流程测试

### 第四阶段：测试和完善 (预计时间: 1天)

- [ ] **单元测试**
   - [x] 为 config 模块编写单元测试
   - [ ] 为 db 模块编写单元测试
   - [ ] 为 schema 模块编写单元测试
   - [ ] 为 exporter 模块编写单元测试
   - [ ] 为 core 模块编写单元测试

- [ ] **集成测试**
   - [ ] 编写端到端集成测试
   - [ ] 测试虚拟列过滤功能
   - [ ] 验证 SQL 输出格式

- [ ] **文档完善**
   - [ ] 完善 README 文档
   - [ ] 添加使用示例

## 详细任务列表

### 任务1: 初始化项目结构
- [x] 创建项目目录结构
- [x] 初始化 go.mod 文件
- [x] 添加 github.com/go-sql-driver/mysql 依赖

### 任务2: 配置管理模块实现
- [x] 创建 internal/config/config.go 文件
- [x] 实现从环境变量加载配置的功能
- [x] 实现默认值处理
- [x] 创建 internal/config/config_test.go 文件
- [x] 编写配置加载的单元测试

### 任务3: 日志系统配置
- [x] 配置全局日志记录器
- [x] 实现统一的日志接口

### 任务4: 数据库连接模块实现
- [x] 创建 internal/db/connection.go 文件
- [x] 实现数据库连接建立和关闭功能
- [x] 实现基本查询功能

### 任务5: 表结构分析模块实现
- [x] 创建 internal/schema/analyzer.go 文件
- [x] 实现 information_schema.COLUMNS 查询功能
- [x] 实现生成列识别和过滤功能
- [x] 构建实际导出列列表

### 任务6: 数据导出模块实现
- [x] 创建 internal/exporter/data.go 文件
- [x] 实现数据查询功能（排除虚拟列）
- [x] 实现 INSERT 语句生成功能（包含具体列名）
- [x] 实现基本环境设置语句生成

### 任务7: 核心流程控制实现
- [x] 创建 internal/core/dump.go 文件
- [x] 实现主流程协调逻辑
- [x] 整合各模块功能

### 任务8: 命令行接口实现
- [x] 创建 cmd/dump/main.go 文件
- [x] 实现命令行参数解析
- [x] 实现主程序执行流程
- [x] 实现错误处理和提示信息

### 任务9: 单元测试编写
- [x] 为 config 模块编写单元测试
- [ ] 为 db 模块编写单元测试
- [ ] 为 schema 模块编写单元测试
- [ ] 为 exporter 模块编写单元测试
- [ ] 为 core 模块编写单元测试

### 任务10: 集成测试编写
- [ ] 编写端到端集成测试
- [ ] 测试虚拟列过滤功能
- [ ] 验证 SQL 输出格式

### 任务11: 文档完善
- [ ] 编写 README.md 文件
- [ ] 添加使用示例
- [ ] 完善注释

## 依赖关系

```
任务1 → 任务2, 任务4
任务2 → 任务7, 任务8
任务4 → 任务5, 任务6
任务5 → 任务6, 任務7
任务6 → 任务7
任务7 → 任务8
任务8 → 任务9, 任务10
任务9 → 任务11
任务10 → 任务11
```

## 风险评估

- [x] **数据库连接问题**
   - [x] 可能遇到不同 MySQL 版本兼容性问题
   - [x] 解决方案：使用标准的 MySQL 驱动并进行多版本测试

- [x] **虚拟列识别准确性**
   - [x] 使用 information_schema.COLUMNS 表查询列信息比解析 DDL 更准确可靠
   - [x] 解决方案：通过检查 EXTRA 字段是否包含 'GENERATED' 关键字来识别虚拟列

- [ ] **性能问题**
   - [ ] 大表导出可能导致内存问题
   - [ ] 解决方案：使用流式处理，逐行查询和输出

- [x] **环境变量配置**
   - [x] 测试时需要管理多个环境变量
   - [x] 解决方案：编写测试辅助函数，确保使用实际环境变量测试

## 验收标准

- [x] 能够通过环境变量成功配置数据库连接
- [x] 能够正确识别并过滤虚拟列
- [x] 能够导出表数据为包含具体列名的 INSERT 语句
- [x] 输出的 SQL 包含基本的环境设置
- [ ] 输出格式正确，可被 MySQL 直接导入
- [x] 提供基本的错误处理和提示信息
- [x] 通过所有单元测试和集成测试